"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[62],{24622(e,n,i){i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"guides/self-hosting/dynamicProxy","title":"Dynamic Proxy Frontend Migration Guide","description":"This guide helps self-hosting system administrators migrate from the legacy zrok access public (publicProxy) to the new v2.0 zrok access dynamicProxy (dynamicProxy) architecture. The dynamicProxy system provides enhanced scalability, namespace-based naming mapping, and full support for OAuth integration.","source":"@site/docs/guides/self-hosting/dynamicProxy.md","sourceDirName":"guides/self-hosting","slug":"/guides/self-hosting/dynamicProxy","permalink":"/docs/zrok/guides/self-hosting/dynamicProxy","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":20,"frontMatter":{"sidebar_position":20},"sidebar":"tutorialSidebar","previous":{"title":"Interstitial Pages","permalink":"/docs/zrok/guides/self-hosting/interstitial-page"},"next":{"title":"Organizations","permalink":"/docs/zrok/guides/self-hosting/organizations"}}');var s=i(74848),t=i(28453);const a={sidebar_position:20},o="Dynamic Proxy Frontend Migration Guide",l={},c=[{value:"Overview",id:"overview",level:2},{value:"What&#39;s Changing",id:"whats-changing",level:3},{value:"Architecture Components",id:"architecture-components",level:3},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Installing RabbitMQ",id:"installing-rabbitmq",level:3},{value:"Docker (Recommended for Testing)",id:"docker-recommended-for-testing",level:4},{value:"Ubuntu/Debian",id:"ubuntudebian",level:4},{value:"RHEL/CentOS/Fedora",id:"rhelcentosfedora",level:4},{value:"Fresh Installation",id:"fresh-installation",level:2},{value:"Step 1: Create dynamicProxyController Identity",id:"step-1-create-dynamicproxycontroller-identity",level:3},{value:"Step 2: Create Ziti Service and Policies",id:"step-2-create-ziti-service-and-policies",level:3},{value:"Step 3: Configure zrok Controller",id:"step-3-configure-zrok-controller",level:3},{value:"Step 4: Create a Namespace",id:"step-4-create-a-namespace",level:3},{value:"Step 5: Create a Dynamic Frontend",id:"step-5-create-a-dynamic-frontend",level:3},{value:"Step 6: Map Namespace to Frontend",id:"step-6-map-namespace-to-frontend",level:3},{value:"Step 7: Configure dynamicProxy Frontend",id:"step-7-configure-dynamicproxy-frontend",level:3},{value:"Required Parameters",id:"required-parameters",level:4},{value:"Optional Parameters",id:"optional-parameters",level:4},{value:"OAuth Configuration (Optional)",id:"oauth-configuration-optional",level:4},{value:"TLS Configuration (Optional)",id:"tls-configuration-optional",level:4},{value:"Step 8: Start dynamicProxy Frontend",id:"step-8-start-dynamicproxy-frontend",level:3},{value:"Step 9: Test with a Share",id:"step-9-test-with-a-share",level:3},{value:"Migrating from publicProxy",id:"migrating-from-publicproxy",level:2},{value:"Option 1: Side-by-Side Operation (Gradual Migration)",id:"option-1-side-by-side-operation-gradual-migration",level:3},{value:"Setup Process",id:"setup-process",level:4},{value:"User Migration Process",id:"user-migration-process",level:4},{value:"Deprecation Timeline",id:"deprecation-timeline",level:4},{value:"Option 2: Clean Cutover (With Downtime)",id:"option-2-clean-cutover-with-downtime",level:3},{value:"Preparation (Before Maintenance Window)",id:"preparation-before-maintenance-window",level:4},{value:"During Maintenance Window",id:"during-maintenance-window",level:4},{value:"Post-Migration",id:"post-migration",level:4},{value:"Comparing Migration Approaches",id:"comparing-migration-approaches",level:3},{value:"Configuration Reference",id:"configuration-reference",level:2},{value:"Complete Configuration Example",id:"complete-configuration-example",level:3},{value:"Namespace Management",id:"namespace-management",level:2},{value:"Creating Namespaces",id:"creating-namespaces",level:3},{value:"Granting Namespace Access",id:"granting-namespace-access",level:3},{value:"Setting Default Namespace",id:"setting-default-namespace",level:3},{value:"Listing Namespaces",id:"listing-namespaces",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Frontend Not Receiving Mapping Updates",id:"frontend-not-receiving-mapping-updates",level:3},{value:"Frontend Cannot Query Controller via gRPC",id:"frontend-cannot-query-controller-via-grpc",level:3},{value:"Shares Don&#39;t Resolve (404 Errors)",id:"shares-dont-resolve-404-errors",level:3},{value:"DNS Not Resolving",id:"dns-not-resolving",level:3},{value:"TLS Certificate Errors",id:"tls-certificate-errors",level:3},{value:"High Memory Usage",id:"high-memory-usage",level:3},{value:"Advanced Configuration",id:"advanced-configuration",level:2},{value:"Multiple Frontend Instances",id:"multiple-frontend-instances",level:3},{value:"Custom Exchange Names",id:"custom-exchange-names",level:3},{value:"Monitoring and Metrics",id:"monitoring-and-metrics",level:3},{value:"Additional Resources",id:"additional-resources",level:2},{value:"Getting Help",id:"getting-help",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"dynamic-proxy-frontend-migration-guide",children:"Dynamic Proxy Frontend Migration Guide"})}),"\n",(0,s.jsxs)(n.p,{children:["This guide helps self-hosting system administrators migrate from the legacy ",(0,s.jsx)(n.code,{children:"zrok access public"})," (",(0,s.jsx)(n.code,{children:"publicProxy"}),") to the new v2.0 ",(0,s.jsx)(n.code,{children:"zrok access dynamicProxy"})," (",(0,s.jsx)(n.code,{children:"dynamicProxy"}),") architecture. The dynamicProxy system provides enhanced scalability, namespace-based naming mapping, and full support for OAuth integration."]}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.h3,{id:"whats-changing",children:"What's Changing"}),"\n",(0,s.jsxs)(n.p,{children:["In zrok v2.0, the public sharing model has been redesigned around ",(0,s.jsx)(n.strong,{children:"namespaces"})," and ",(0,s.jsx)(n.strong,{children:"names"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"v1.x model"}),": shares created with ",(0,s.jsx)(n.code,{children:"zrok share public"})," or ",(0,s.jsx)(n.code,{children:"zrok reserve public"})," connected directly to a public frontend"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"v2.0 model"}),": shares use reserved or ephemeral ",(0,s.jsx)(n.strong,{children:"names"})," within ",(0,s.jsx)(n.strong,{children:"namespaces"}),", which are mapped to dynamic frontends"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The new ",(0,s.jsx)(n.code,{children:"dynamicProxy"})," frontend replaces ",(0,s.jsx)(n.code,{children:"publicProxy"})," with several key improvements:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Namespace-based organization"}),": logical grouping of names similar to DNS zones"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Distributed mapping updates"}),": AMQP-based real-time synchronization across multiple frontend instances"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Enhanced scalability"}),": multiple dynamicProxy instances can serve the same namespace"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"gRPC communication"}),": efficient controller-to-frontend communication for mapping queries"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"architecture-components",children:"Architecture Components"}),"\n",(0,s.jsx)(n.p,{children:"The dynamicProxy system consists of three main components:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"dynamicProxyController"})," (in zrok controller)"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"gRPC service for mapping queries from frontends"}),"\n",(0,s.jsx)(n.li,{children:"AMQP publisher for broadcasting mapping updates"}),"\n",(0,s.jsxs)(n.li,{children:["Manages the distribution of namespace/name to share mappings across your entire fleet of ",(0,s.jsx)(n.code,{children:"dynamicProxy"})," instances"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"AMQP Message Broker"})," (RabbitMQ)"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"distributes mapping updates from controller to all frontend instances"}),"\n",(0,s.jsx)(n.li,{children:"enables real-time synchronization across distributed frontends"}),"\n",(0,s.jsx)(n.li,{children:"requires minimal configuration (topic exchange)"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"dynamicProxy Frontend"})," (runs via ",(0,s.jsx)(n.code,{children:"zrok access dynamicProxy"}),")"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"HTTP/HTTPS listener serving dynamic share mappings"}),"\n",(0,s.jsx)(n.li,{children:"AMQP subscriber receiving mapping updates"}),"\n",(0,s.jsx)(n.li,{children:"gRPC client for initial mapping queries and on-demand lookups"}),"\n",(0,s.jsx)(n.li,{children:"optional OAuth integration for authentication"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.mermaid,{value:'graph TB\n    subgraph "zrok Controller"\n        DPC[dynamicProxyController<br/>gRPC + AMQP Publisher]\n    end\n\n    subgraph "Message Broker"\n        AMQP[RabbitMQ<br/>Topic Exchange]\n    end\n\n    subgraph "Frontend Instances"\n        DP1[dynamicProxy 1<br/>gRPC Client + AMQP Subscriber]\n        DP2[dynamicProxy 2<br/>gRPC Client + AMQP Subscriber]\n        DP3[dynamicProxy N<br/>gRPC Client + AMQP Subscriber]\n    end\n\n    subgraph "Users"\n        U1[User Shares]\n        U2[User Shares]\n    end\n\n    DPC --\x3e|publishes mapping updates| AMQP\n    AMQP --\x3e|broadcasts updates| DP1\n    AMQP --\x3e|broadcasts updates| DP2\n    AMQP --\x3e|broadcasts updates| DP3\n\n    DP1 -.->|queries mappings via gRPC| DPC\n    DP2 -.->|queries mappings via gRPC| DPC\n    DP3 -.->|queries mappings via gRPC| DPC\n\n    U1 --\x3e|creates shares| DPC\n    U2 --\x3e|creates shares| DPC\n\n    Internet[Internet Traffic] --\x3e DP1\n    Internet --\x3e DP2\n    Internet --\x3e DP3'}),"\n",(0,s.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,s.jsxs)(n.p,{children:["Before setting up ",(0,s.jsx)(n.code,{children:"dynamicProxy"}),", ensure you have:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"RabbitMQ"}),": AMQP 0.9.1 compatible message broker (version 3.x or higher recommended)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Ziti Controller Access"}),": administrative access to create identities, services, and policies"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Running zrok Controller"}),": v2.0 or higher with administrative credentials"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"DNS Configuration"}),": ability to create DNS records for your frontend domain"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"TLS Certificates"}),": for HTTPS frontends (Let's Encrypt recommended)"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"installing-rabbitmq",children:"Installing RabbitMQ"}),"\n",(0,s.jsx)(n.p,{children:"RabbitMQ is available through most package managers. Here are installation options:"}),"\n",(0,s.jsx)(n.h4,{id:"docker-recommended-for-testing",children:"Docker (Recommended for Testing)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker run -d --name rabbitmq \\\n  -p 5672:5672 \\\n  -p 15672:15672 \\\n  rabbitmq:3-management\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The management UI will be available at ",(0,s.jsx)(n.code,{children:"http://localhost:15672"})," (default credentials: ",(0,s.jsx)(n.code,{children:"guest"}),"/",(0,s.jsx)(n.code,{children:"guest"}),")."]}),"\n",(0,s.jsx)(n.h4,{id:"ubuntudebian",children:"Ubuntu/Debian"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo apt-get install rabbitmq-server\nsudo systemctl enable rabbitmq-server\nsudo systemctl start rabbitmq-server\n"})}),"\n",(0,s.jsx)(n.h4,{id:"rhelcentosfedora",children:"RHEL/CentOS/Fedora"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo dnf install rabbitmq-server\nsudo systemctl enable rabbitmq-server\nsudo systemctl start rabbitmq-server\n"})}),"\n",(0,s.jsxs)(n.p,{children:["For production deployments, consult the ",(0,s.jsx)(n.a,{href:"https://www.rabbitmq.com/download.html",children:"RabbitMQ documentation"})," for best practices on clustering, persistence, and monitoring."]}),"\n",(0,s.jsx)(n.h2,{id:"fresh-installation",children:"Fresh Installation"}),"\n",(0,s.jsx)(n.p,{children:"This section covers setting up dynamicProxy from scratch on a new zrok instance."}),"\n",(0,s.jsx)(n.h3,{id:"step-1-create-dynamicproxycontroller-identity",children:"Step 1: Create dynamicProxyController Identity"}),"\n",(0,s.jsx)(n.p,{children:"First, create a Ziti identity for the dynamicProxyController service:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"zrok2 admin create identity dynamicProxyController\n"})}),"\n",(0,s.jsxs)(n.p,{children:["This command outputs the identity details. Save the identity's Ziti ID (starts with a letter, like ",(0,s.jsx)(n.code,{children:"aBc123"}),"), as you'll need it for the next steps."]}),"\n",(0,s.jsxs)(n.p,{children:["The identity configuration file is saved to ",(0,s.jsx)(n.code,{children:"~/.zrok2/identities/dynamicProxyController.json"})," by default."]}),"\n",(0,s.jsx)(n.h3,{id:"step-2-create-ziti-service-and-policies",children:"Step 2: Create Ziti Service and Policies"}),"\n",(0,s.jsx)(n.p,{children:"Using the Ziti CLI, create a service for the dynamicProxyController and the necessary policies:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'# Set variables for convenience\nCONTROLLER_ZID="<ziti-id-from-step-1>"\nSERVICE_NAME="dynamicProxyController"\n\n# Create the service\nziti edge create service "$SERVICE_NAME"\n\n# Create Service Edge Router Policy (allows edge routers to see the service)\nziti edge create serp "${SERVICE_NAME}-serp" \\\n  --edge-router-roles \'#all\' \\\n  --service-roles "@${SERVICE_NAME}"\n\n# Create Service Policy for Bind (allows controller identity to bind the service)\nziti edge create sp "${SERVICE_NAME}-bind" Bind \\\n  --identity-roles "@${CONTROLLER_ZID}" \\\n  --service-roles "@${SERVICE_NAME}"\n\n# Create Service Policy for Dial (allows frontend to dial the service)\n# Note: Replace \'public\' with your frontend identity name if different\nziti edge create sp "${SERVICE_NAME}-dial" Dial \\\n  --identity-roles "@public" \\\n  --service-roles "@${SERVICE_NAME}"\n'})}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"public"})," identity referenced in the dial policy should be the identity used by your dynamicProxy frontends. If you use a different identity name, adjust the command accordingly. You can create multiple dial policies for different frontend identities if needed."]})}),"\n",(0,s.jsx)(n.h3,{id:"step-3-configure-zrok-controller",children:"Step 3: Configure zrok Controller"}),"\n",(0,s.jsxs)(n.p,{children:["Add the dynamicProxyController configuration to your zrok controller configuration file (typically ",(0,s.jsx)(n.code,{children:"etc/dev.yml"})," or your production config):"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# Add to your existing controller configuration\ndynamic_proxy_controller:\n  identity_path: /home/zrok/.zrok2/identities/dynamicProxyController.json\n  service_name: dynamicProxyController\n\n  amqp_publisher:\n    url: amqp://guest:guest@localhost:5672\n    exchange_name: dynamicProxy\n"})}),"\n",(0,s.jsx)(n.p,{children:"Configuration parameters:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"identity_path"})}),": absolute path to the dynamicProxyController identity JSON file created in Step 1"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"service_name"})}),": name of the Ziti service created in Step 2 (must match)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"amqp_publisher.url"})}),": AMQP connection URL for RabbitMQ (format: ",(0,s.jsx)(n.code,{children:"amqp://username:password@host:port"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"amqp_publisher.exchange_name"})}),": AMQP exchange name for mapping updates (can be any name, must match frontend config)"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Restart your zrok controller to apply the configuration:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# If using systemd\nsudo systemctl restart zrok-controller\n\n# If running manually\n# Stop the controller (Ctrl+C) and restart it\nzrok2 controller etc/ctrl.yml\n"})}),"\n",(0,s.jsx)(n.h3,{id:"step-4-create-a-namespace",children:"Step 4: Create a Namespace"}),"\n",(0,s.jsx)(n.p,{children:"Namespaces provide logical grouping for names. Create your first namespace:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Create an open namespace (anyone can create names in it)\nzrok2 admin create namespace --token public --open zrok.example.com\n\n# Or create a closed namespace (requires grants)\nzrok2 admin create namespace --token private private.example.com\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The command outputs a namespace token (e.g., ",(0,s.jsx)(n.code,{children:"abc123xyz"}),"). Save this token as you'll need it for frontend mapping and when creating names."]}),"\n",(0,s.jsx)(n.p,{children:"Parameters:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--token"})," specifies the namespace token used to refer to this specific namespace (the identifier)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--open"}),": open mode (users can create names without grants); without ",(0,s.jsx)(n.code,{children:"--open"}),' is "closed mode" where users need explicit grants to create names in the namespace (use ',(0,s.jsx)(n.code,{children:"zrok admin create namespace-grant"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:["And the name (",(0,s.jsx)(n.code,{children:"zrok.example.com"}),") is the DNS name for the namespace; names will end up being ",(0,s.jsx)(n.code,{children:"myshare.zrok.example.com"})]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"step-5-create-a-dynamic-frontend",children:"Step 5: Create a Dynamic Frontend"}),"\n",(0,s.jsx)(n.p,{children:"Create a frontend with the dynamic flag enabled:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'zrok2 admin create frontend --dynamic public "http://{token}.zrok.example.com:8080"\n'})}),"\n",(0,s.jsxs)(n.p,{children:["This creates a dynamic frontend and outputs a frontend token (e.g., ",(0,s.jsx)(n.code,{children:"KMmfE0VXO7Pp"}),")."]}),"\n",(0,s.jsx)(n.p,{children:"Command breakdown:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"--dynamic"})}),": enables dynamic mode (required for dynamicProxy)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"public"})}),": Ziti identity that will bind the frontend (must have dial permissions to dynamicProxyController service)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:'"http://{token}.zrok.example.com:8080"'})}),": URL template for shares","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["This is the legacy URL template used with legacy ",(0,s.jsx)(n.code,{children:"publicProxy"})," frontends; disregarded by new v2 ",(0,s.jsx)(n.code,{children:"dynamicProxy"})," installations and will be removed in future versions of zrok"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"{token}"})," is replaced with the share token or name"]}),"\n",(0,s.jsxs)(n.li,{children:["can use ",(0,s.jsx)(n.code,{children:"https"})," if you configure TLS in the frontend config"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"step-6-map-namespace-to-frontend",children:"Step 6: Map Namespace to Frontend"}),"\n",(0,s.jsx)(n.p,{children:"Link the namespace to the frontend so shares in the namespace are served by this frontend:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"zrok2 admin create namespace-frontend <namespaceToken> <frontendToken>\n"})}),"\n",(0,s.jsx)(n.p,{children:"You can map multiple frontends to a single namespace for load balancing and high availability. All mapped frontends will receive the same mapping updates via AMQP."}),"\n",(0,s.jsxs)(n.p,{children:["For simple horizontal scalability (behind a load balancer) you can create one logical frontend in the zrok controller, and share the frontendToken and identity amongst multiple ",(0,s.jsx)(n.code,{children:"zrok access dynamicProxy"})," instances"]}),"\n",(0,s.jsx)(n.p,{children:"To view existing mappings:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# List frontends for a namespace\nzrok2 admin list namespaceFrontendMappings <namespaceToken>\n\n# List namespaces for a frontend\nzrok2 admin list frontendNamespaceMappings <frontendToken>\n"})}),"\n",(0,s.jsx)(n.h3,{id:"step-7-configure-dynamicproxy-frontend",children:"Step 7: Configure dynamicProxy Frontend"}),"\n",(0,s.jsxs)(n.p,{children:["Create a configuration file for the dynamicProxy frontend (e.g., ",(0,s.jsx)(n.code,{children:"etc/dynamicProxy.yml"}),"):"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'v: 1\n\nfrontend_token: <frontendToken-from-step-5>\nidentity: public\nbind_address: "0.0.0.0:8080"\nmapping_refresh_interval: 1m\n\namqp_subscriber:\n  url: amqp://guest:guest@localhost:5672\n  exchange_name: dynamicProxy\n\ncontroller:\n  identity_path: /home/zrok/.zrok2/identities/public.json\n  service_name: dynamicProxyController\n'})}),"\n",(0,s.jsx)(n.p,{children:"Configuration parameters:"}),"\n",(0,s.jsx)(n.h4,{id:"required-parameters",children:"Required Parameters"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"v"})}),": configuration version (always ",(0,s.jsx)(n.code,{children:"1"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"frontend_token"})}),": token from ",(0,s.jsx)(n.code,{children:"zrok admin create frontend"})," (Step 5)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"amqp_subscriber.url"})}),": RabbitMQ connection URL (must match controller's ",(0,s.jsx)(n.code,{children:"amqp_publisher.url"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"amqp_subscriber.exchange_name"})}),": AMQP exchange name (must match controller's ",(0,s.jsx)(n.code,{children:"amqp_publisher.exchange_name"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"controller.identity_path"})}),": path to the Ziti identity JSON file for the frontend"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"controller.service_name"})}),": Ziti service name for dynamicProxyController (must match Step 2 and controller config)"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"optional-parameters",children:"Optional Parameters"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"identity"})}),": Ziti identity name to use (default: ",(0,s.jsx)(n.code,{children:'"public"'}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"bind_address"})}),": IP and port where the frontend listens (default: ",(0,s.jsx)(n.code,{children:'"0.0.0.0:8080"'}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"mapping_refresh_interval"})}),": how often to audit (and potentially refresh) mappings from controller (default: ",(0,s.jsx)(n.code,{children:"5m"}),")"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"oauth-configuration-optional",children:"OAuth Configuration (Optional)"}),"\n",(0,s.jsxs)(n.p,{children:["To enable OAuth authentication, add an ",(0,s.jsx)(n.code,{children:"oauth"})," section. For detailed OAuth setup, see the ",(0,s.jsx)(n.a,{href:"/docs/zrok/guides/self-hosting/oauth/configuring-oauth",children:"OAuth Configuration Guide"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'oauth:\n  bind_address: "0.0.0.0:8181"\n  endpoint_url: "https://oauth.zrok.example.com"\n  cookie_name: "zrok-auth-session"\n  cookie_domain: "zrok.example.com"\n  session_lifetime: "6h"\n  intermediate_lifetime: "5m"\n  signing_key: "your-unique-signing-key-32-chars-min"\n  encryption_key: "your-unique-encryption-key-24-chars-min"\n\n  providers:\n    - name: "google"\n      type: "google"\n      client_id: "<google-client-id>"\n      client_secret: "<google-client-secret>"\n'})}),"\n",(0,s.jsx)(n.h4,{id:"tls-configuration-optional",children:"TLS Configuration (Optional)"}),"\n",(0,s.jsxs)(n.p,{children:["For HTTPS frontends, add a ",(0,s.jsx)(n.code,{children:"tls"})," section:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"tls:\n  cert_path: /etc/letsencrypt/live/zrok.example.com/fullchain.pem\n  key_path: /etc/letsencrypt/live/zrok.example.com/privkey.pem\n"})}),"\n",(0,s.jsx)(n.h3,{id:"step-8-start-dynamicproxy-frontend",children:"Step 8: Start dynamicProxy Frontend"}),"\n",(0,s.jsx)(n.p,{children:"Run the dynamicProxy frontend using your configuration:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"zrok2 access dynamicProxy etc/dynamicProxy.yml\n"})}),"\n",(0,s.jsx)(n.p,{children:"The frontend will:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Connect to the Ziti network using the configured identity"}),"\n",(0,s.jsx)(n.li,{children:"Subscribe to the AMQP exchange for mapping updates"}),"\n",(0,s.jsx)(n.li,{children:"Query the controller via gRPC for initial mappings"}),"\n",(0,s.jsx)(n.li,{children:"Start serving HTTP/HTTPS traffic on the configured bind address"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"For production deployments, consider using a process manager like systemd:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ini",children:"# /etc/systemd/system/zrok-dynamicproxy.service\n[Unit]\nDescription=zrok Dynamic Proxy Frontend\nAfter=network.target rabbitmq-server.service\n\n[Service]\nType=simple\nUser=zrok\nGroup=zrok\nWorkingDirectory=/home/zrok\nExecStart=/usr/local/bin/zrok2 access dynamicProxy /home/zrok/etc/dynamicProxy.yml\nRestart=always\nRestartSec=10\n\n[Install]\nWantedBy=multi-user.target\n"})}),"\n",(0,s.jsx)(n.p,{children:"Enable and start the service:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo systemctl enable zrok-dynamicproxy\nsudo systemctl start zrok-dynamicproxy\nsudo systemctl status zrok-dynamicproxy\n"})}),"\n",(0,s.jsx)(n.h3,{id:"step-9-test-with-a-share",children:"Step 9: Test with a Share"}),"\n",(0,s.jsx)(n.p,{children:"Create a test share to verify the setup:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# First, enable a zrok environment if you haven't already\nzrok2 enable <accountToken>\n\n# Set the default namespace for convenience\nzrok2 config set defaultNamespace <namespaceToken>\n\n# Create a reserved name in the namespace\nzrok2 create name -n <namespaceToken> my-test-share\n\n# Share a resource using the reserved name\nzrok2 share public --backend-mode web -n <namespaceToken>:my-test-share ~/public\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Access your share at ",(0,s.jsx)(n.code,{children:"http://my-test-share.zrok.example.com:8080"})," (adjust domain/port based on your configuration)."]}),"\n",(0,s.jsx)(n.p,{children:"If you see your shared content, congratulations! Your dynamicProxy setup is working correctly."}),"\n",(0,s.jsx)(n.h2,{id:"migrating-from-publicproxy",children:"Migrating from publicProxy"}),"\n",(0,s.jsxs)(n.p,{children:["If you're currently running ",(0,s.jsx)(n.code,{children:"zrok access public"})," (publicProxy) and want to migrate to dynamicProxy, you have two main approaches:"]}),"\n",(0,s.jsx)(n.h3,{id:"option-1-side-by-side-operation-gradual-migration",children:"Option 1: Side-by-Side Operation (Gradual Migration)"}),"\n",(0,s.jsx)(n.p,{children:"This approach allows both publicProxy and dynamicProxy to run simultaneously, enabling gradual user migration with no downtime."}),"\n",(0,s.jsx)(n.h4,{id:"setup-process",children:"Setup Process"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Complete Steps 1-8"})," from the Fresh Installation section without shutting down your existing publicProxy"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Create separate DNS entries"})," for the new dynamicProxy frontend (e.g., ",(0,s.jsx)(n.code,{children:"v2.zrok.example.com"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Communicate the migration"})," to your users:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"users on v1.x clients can continue using the old publicProxy"}),"\n",(0,s.jsx)(n.li,{children:"users on v2.0+ clients can start using namespaces and names with dynamicProxy"}),"\n",(0,s.jsx)(n.li,{children:"provide a migration deadline"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"user-migration-process",children:"User Migration Process"}),"\n",(0,s.jsx)(n.p,{children:"Users need to:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Upgrade to zrok v2.0+"}),"\n",(0,s.jsxs)(n.li,{children:["Set the default namespace: ",(0,s.jsx)(n.code,{children:"zrok2 config set defaultNamespace <namespaceToken>"})]}),"\n",(0,s.jsxs)(n.li,{children:["Recreate their shares using names:","\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Instead of: zrok2 reserve public 8080\n# They use:\nzrok2 create name my-app\nzrok2 share public localhost:8080 -n <namespaceToken>:my-app\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"deprecation-timeline",children:"Deprecation Timeline"}),"\n",(0,s.jsx)(n.p,{children:"Once user adoption reaches your target threshold:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Announce the publicProxy shutdown date (recommend 30+ days notice)"}),"\n",(0,s.jsx)(n.li,{children:"Monitor publicProxy usage via controller metrics"}),"\n",(0,s.jsx)(n.li,{children:"Contact remaining users directly if possible"}),"\n",(0,s.jsx)(n.li,{children:"Shut down publicProxy and remove DNS entries"}),"\n",(0,s.jsx)(n.li,{children:"Update documentation to remove v1.x references"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"option-2-clean-cutover-with-downtime",children:"Option 2: Clean Cutover (With Downtime)"}),"\n",(0,s.jsx)(n.p,{children:"This approach requires downtime but provides a clean migration in a single maintenance window."}),"\n",(0,s.jsx)(n.h4,{id:"preparation-before-maintenance-window",children:"Preparation (Before Maintenance Window)"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Complete Steps 1-7"})," from the Fresh Installation section"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Test dynamicProxy configuration"})," thoroughly in a staging environment"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Notify all users"})," of the scheduled maintenance window"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Prepare migration documentation"})," for users"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"during-maintenance-window",children:"During Maintenance Window"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Shut down publicProxy"})," (",(0,s.jsx)(n.code,{children:"zrok access public"})," processes)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Start dynamicProxy"})," with the same DNS entries as the old publicProxy"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Notify users"})," to upgrade to v2.0+ and recreate their shares using names"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Provide support channels"})," for migration assistance"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"post-migration",children:"Post-Migration"}),"\n",(0,s.jsx)(n.p,{children:"All users must:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Upgrade to zrok v2.0+"}),"\n",(0,s.jsxs)(n.li,{children:["Set default namespace: ",(0,s.jsx)(n.code,{children:"zrok2 config set defaultNamespace <namespaceToken>"})]}),"\n",(0,s.jsx)(n.li,{children:"Recreate shares as shown in Option 1"}),"\n"]}),"\n",(0,s.jsx)(n.admonition,{type:"warning",children:(0,s.jsx)(n.p,{children:"Clean cutover means existing v1.x shares will stop working immediately. Only choose this approach if you can ensure all users upgrade and recreate their shares promptly, or if downtime is acceptable."})}),"\n",(0,s.jsx)(n.h3,{id:"comparing-migration-approaches",children:"Comparing Migration Approaches"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Aspect"}),(0,s.jsx)(n.th,{children:"Side-by-Side"}),(0,s.jsx)(n.th,{children:"Clean Cutover"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Downtime"})}),(0,s.jsx)(n.td,{children:"None"}),(0,s.jsx)(n.td,{children:"Required"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Complexity"})}),(0,s.jsx)(n.td,{children:"Higher (manage two systems)"}),(0,s.jsx)(n.td,{children:"Lower (single system)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"User Impact"})}),(0,s.jsx)(n.td,{children:"Gradual, self-paced"}),(0,s.jsx)(n.td,{children:"Immediate, forced"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Resource Usage"})}),(0,s.jsx)(n.td,{children:"Higher (duplicate frontends)"}),(0,s.jsx)(n.td,{children:"Lower (single frontend)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Rollback"})}),(0,s.jsx)(n.td,{children:"Easy (keep publicProxy)"}),(0,s.jsx)(n.td,{children:"Difficult"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Timeline"})}),(0,s.jsx)(n.td,{children:"Weeks to months"}),(0,s.jsx)(n.td,{children:"Single maintenance window"})]})]})]}),"\n",(0,s.jsx)(n.p,{children:"Choose side-by-side for larger deployments with diverse users, or clean cutover for smaller deployments with coordinated users."}),"\n",(0,s.jsx)(n.h2,{id:"configuration-reference",children:"Configuration Reference"}),"\n",(0,s.jsx)(n.h3,{id:"complete-configuration-example",children:"Complete Configuration Example"}),"\n",(0,s.jsxs)(n.p,{children:["Here's a complete ",(0,s.jsx)(n.code,{children:"dynamicProxy"})," configuration with all available options:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'v: 1\n\n# Frontend identification\nfrontend_token: KMmfE0VXO7Pp\nidentity: public\nbind_address: "0.0.0.0:8080"\n\n# Mapping refresh interval\nmapping_refresh_interval: 1m\n\n# AMQP subscriber for receiving mapping updates\namqp_subscriber:\n  url: amqp://guest:guest@localhost:5672\n  exchange_name: dynamicProxy\n  queue_depth: 1024  # Optional: buffer size for mapping updates (default: 1024)\n\n# Controller client for gRPC queries\ncontroller:\n  identity_path: /home/zrok/.zrok2/identities/public.json\n  service_name: dynamicProxyController\n  timeout: 30s  # Optional: gRPC request timeout (default: 30s)\n\n# Optional: TLS configuration for HTTPS\ntls:\n  cert_path: /etc/letsencrypt/live/zrok.example.com/fullchain.pem\n  key_path: /etc/letsencrypt/live/zrok.example.com/privkey.pem\n\n# Optional: Interstitial page configuration\ninterstitial:\n  enabled: true\n  html_path: /etc/zrok/interstitial.html\n  user_agent_prefixes:\n    - "Mozilla/"\n    - "Chrome/"\n\n# Optional: OAuth configuration\noauth:\n  bind_address: "127.0.0.1:8181"\n  endpoint_url: "https://oauth.zrok.example.com:8443"\n  cookie_name: "zrok-auth-session"\n  cookie_domain: "zrok.example.com"\n  session_lifetime: "6h"\n  intermediate_lifetime: "5m"\n  signing_key: "your-32-plus-character-signing-key-here"\n  encryption_key: "your-24-plus-character-encryption-key-here"\n  max_cookie_size: 3072  # Optional: maximum cookie size in bytes (default: 3072)\n\n  providers:\n    # Google OAuth\n    - name: "google"\n      type: "google"\n      client_id: "your-google-client-id"\n      client_secret: "your-google-client-secret"\n\n    # GitHub OAuth\n    - name: "github"\n      type: "github"\n      client_id: "your-github-client-id"\n      client_secret: "your-github-client-secret"\n\n    # Generic OIDC\n    - name: "microsoft"\n      type: "oidc"\n      client_id: "your-oidc-client-id"\n      client_secret: "your-oidc-client-secret"\n      scopes: ["openid", "email", "profile"]\n      issuer: "https://login.microsoftonline.com/<tenant-id>/v2.0"\n      supports_pkce: true\n'})}),"\n",(0,s.jsxs)(n.p,{children:["For detailed OAuth provider configuration, see the ",(0,s.jsx)(n.a,{href:"/docs/zrok/guides/self-hosting/oauth/configuring-oauth",children:"OAuth Configuration Guide"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"namespace-management",children:"Namespace Management"}),"\n",(0,s.jsx)(n.p,{children:"After setting up dynamicProxy, you'll need to manage namespaces and names for your users."}),"\n",(0,s.jsx)(n.h3,{id:"creating-namespaces",children:"Creating Namespaces"}),"\n",(0,s.jsxs)(n.p,{children:["Namespaces can be ",(0,s.jsx)(n.strong,{children:"open"})," (anyone can create names) or ",(0,s.jsx)(n.strong,{children:"closed"})," (requires grants):"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'# Open namespace - users can freely create names\nzrok2 admin create namespace public "Public Shares" -o\n\n# Closed namespace - requires explicit grants\nzrok2 admin create namespace private "Private Shares"\n'})}),"\n",(0,s.jsx)(n.h3,{id:"granting-namespace-access",children:"Granting Namespace Access"}),"\n",(0,s.jsx)(n.p,{children:"For closed namespaces, grant users access by email:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"zrok2 admin add namespaceGrant <namespaceToken> user@example.com\n"})}),"\n",(0,s.jsx)(n.p,{children:"Remove grants with:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"zrok2 admin remove namespaceGrant <namespaceToken> user@example.com\n"})}),"\n",(0,s.jsx)(n.h3,{id:"setting-default-namespace",children:"Setting Default Namespace"}),"\n",(0,s.jsx)(n.p,{children:"Users can set their default namespace to avoid specifying it on every command:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"zrok2 config set defaultNamespace <namespaceToken>\n"})}),"\n",(0,s.jsx)(n.p,{children:"Or via environment variable:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"export ZROK2_DEFAULT_NAMESPACE=<namespaceToken>\n"})}),"\n",(0,s.jsx)(n.h3,{id:"listing-namespaces",children:"Listing Namespaces"}),"\n",(0,s.jsx)(n.p,{children:"Users can see available namespaces (based on grants and open namespaces):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"zrok2 list namespaces\n"})}),"\n",(0,s.jsx)(n.p,{children:"Administrators can list all namespaces:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"zrok2 admin list namespaces\n"})}),"\n",(0,s.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,s.jsx)(n.h3,{id:"frontend-not-receiving-mapping-updates",children:"Frontend Not Receiving Mapping Updates"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Symptoms"}),": shares are created but don't resolve, frontend logs show no mapping updates"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Diagnostics"}),":"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Verify AMQP connectivity:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Test RabbitMQ connection\ncurl -u guest:guest http://localhost:15672/api/overview\n\n# Check if exchange exists\ncurl -u guest:guest http://localhost:15672/api/exchanges/%2F/dynamicProxy\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Check controller logs for AMQP publisher errors:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# If using systemd\nsudo journalctl -u zrok-controller -f\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Verify frontend logs for AMQP subscriber connection:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# If using systemd\nsudo journalctl -u zrok-dynamicproxy -f\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Solutions"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Ensure ",(0,s.jsx)(n.code,{children:"exchange_name"})," matches in both controller and frontend configs"]}),"\n",(0,s.jsx)(n.li,{children:"Verify RabbitMQ is running and accessible from both controller and frontend hosts"}),"\n",(0,s.jsx)(n.li,{children:"Check firewall rules if RabbitMQ is on a separate host"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"frontend-cannot-query-controller-via-grpc",children:"Frontend Cannot Query Controller via gRPC"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Symptoms"}),": frontend starts but shows errors querying mappings, shares don't resolve"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Diagnostics"}),":"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Verify Ziti connectivity:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Test if frontend can reach dynamicProxyController service\nziti edge list services --name dynamicProxyController\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Check service policies:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Verify bind policy exists\nziti edge list service-policies --name dynamicProxyController-bind\n\n# Verify dial policy exists for frontend identity\nziti edge list service-policies --name dynamicProxyController-dial\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Check controller logs for gRPC server errors:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo journalctl -u zrok-controller | grep -i grpc\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Solutions"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Ensure ",(0,s.jsx)(n.code,{children:"service_name"})," matches in controller config, frontend config, and Ziti service name"]}),"\n",(0,s.jsx)(n.li,{children:"Verify the frontend identity has dial permissions (Step 2)"}),"\n",(0,s.jsx)(n.li,{children:"Confirm controller identity has bind permissions (Step 2)"}),"\n",(0,s.jsx)(n.li,{children:"Check that both identities are enrolled and connected to Ziti"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"shares-dont-resolve-404-errors",children:"Shares Don't Resolve (404 Errors)"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Symptoms"}),": accessing ",(0,s.jsx)(n.code,{children:"http://<name>.zrok.example.com"})," returns 404"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Diagnostics"}),":"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Verify namespace-to-frontend mapping exists:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"zrok2 admin list namespace-frontend <namespaceToken>\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Check if the name exists:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"zrok2 list names\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Verify the share is active:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"zrok2 list shares\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Check frontend logs for mapping presence:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo journalctl -u zrok-dynamicproxy -f\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Solutions"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Create namespace-to-frontend mapping if missing (Step 6)"}),"\n",(0,s.jsx)(n.li,{children:"Verify the share is using the correct namespace token"}),"\n",(0,s.jsx)(n.li,{children:"Restart the share if it was created before the mapping"}),"\n",(0,s.jsx)(n.li,{children:"Check that the frontend token in config matches the frontend created in Step 5"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"dns-not-resolving",children:"DNS Not Resolving"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Symptoms"}),": domain names don't resolve or resolve to wrong IP"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Diagnostics"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Test DNS resolution\ndig my-share.zrok.example.com\n\n# Check if DNS propagates correctly\nnslookup my-share.zrok.example.com\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Solutions"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Ensure wildcard DNS record exists: ",(0,s.jsx)(n.code,{children:"*.zrok.example.com -> <frontend-ip>"})]}),"\n",(0,s.jsx)(n.li,{children:"Wait for DNS propagation (can take minutes to hours)"}),"\n",(0,s.jsxs)(n.li,{children:["Use ",(0,s.jsx)(n.code,{children:"/etc/hosts"})," for local testing: ",(0,s.jsx)(n.code,{children:"127.0.0.1 my-share.zrok.example.com"})]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"tls-certificate-errors",children:"TLS Certificate Errors"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Symptoms"}),": browser shows certificate warnings, HTTPS connections fail"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Solutions"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Use a wildcard certificate for ",(0,s.jsx)(n.code,{children:"*.zrok.example.com"})]}),"\n",(0,s.jsxs)(n.li,{children:["Verify certificate paths in ",(0,s.jsx)(n.code,{children:"tls"})," configuration are correct and readable"]}),"\n",(0,s.jsxs)(n.li,{children:["For Let's Encrypt, use DNS challenge for wildcard certificates:","\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"certbot certonly --manual --preferred-challenges dns \\\n  -d '*.zrok.example.com' -d 'zrok.example.com'\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"high-memory-usage",children:"High Memory Usage"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Symptoms"}),": dynamicProxy or controller consuming excessive memory"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Diagnostics"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Check memory usage\nps aux | grep zrok\n\n# Monitor AMQP queue depth\ncurl -u guest:guest http://localhost:15672/api/queues/%2F/<queue-name>\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Solutions"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Reduce ",(0,s.jsx)(n.code,{children:"mapping_refresh_interval"})," if it's too frequent"]}),"\n",(0,s.jsxs)(n.li,{children:["Adjust ",(0,s.jsx)(n.code,{children:"queue_depth"})," in AMQP subscriber config"]}),"\n",(0,s.jsx)(n.li,{children:"Consider multiple frontend instances with load balancing instead of increasing resources"}),"\n",(0,s.jsx)(n.li,{children:"Monitor and limit the number of active shares per namespace"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"advanced-configuration",children:"Advanced Configuration"}),"\n",(0,s.jsx)(n.h3,{id:"multiple-frontend-instances",children:"Multiple Frontend Instances"}),"\n",(0,s.jsx)(n.p,{children:"For high availability and load balancing, run multiple dynamicProxy instances:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Create separate configuration files for each instance (with unique bind addresses if on the same host)"}),"\n",(0,s.jsxs)(n.li,{children:["Map the same namespace to multiple frontends:","\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"zrok2 admin create namespace-frontend <namespaceToken> <frontendToken1>\nzrok2 admin create namesapce-frontend <namespaceToken> <frontendToken2>\n"})}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"Use a load balancer (nginx, HAProxy, etc.) in front of the instances"}),"\n",(0,s.jsx)(n.li,{children:"Each instance will receive mapping updates via AMQP independently"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"custom-exchange-names",children:"Custom Exchange Names"}),"\n",(0,s.jsx)(n.p,{children:"You can use different AMQP exchange names for different frontend groups:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# Controller config\ndynamic_proxy_controller:\n  amqp_publisher:\n    exchange_name: dynamicProxy-prod\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# Frontend config\namqp_subscriber:\n  exchange_name: dynamicProxy-prod\n"})}),"\n",(0,s.jsx)(n.p,{children:"This allows you to isolate mapping updates between different deployment environments (prod, staging, etc.)."}),"\n",(0,s.jsx)(n.h3,{id:"monitoring-and-metrics",children:"Monitoring and Metrics"}),"\n",(0,s.jsx)(n.p,{children:"Integrate with your monitoring stack:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"RabbitMQ metrics"}),": Use the management plugin to monitor queue depth, message rates, and connections"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"zrok controller metrics"}),": if you've configured InfluxDB metrics (see ",(0,s.jsx)(n.a,{href:"/docs/zrok/guides/self-hosting/metrics-and-limits/configuring-metrics",children:"Configuring Metrics"}),"), monitor:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Frontend registration count"}),"\n",(0,s.jsx)(n.li,{children:"Mapping update frequency"}),"\n",(0,s.jsx)(n.li,{children:"gRPC request latency"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Frontend logs"}),": parse structured logs for error rates and performance data"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"additional-resources",children:"Additional Resources"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/docs/zrok/guides/self-hosting/oauth/configuring-oauth",children:"OAuth Configuration Guide"})," - detailed OAuth provider setup"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/docs/zrok/guides/self-hosting/metrics-and-limits/configuring-metrics",children:"Configuring Metrics"})," - InfluxDB integration for monitoring"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/docs/zrok/guides/self-hosting/interstitial-page",children:"Interstitial Page Configuration"})," - customizing the interstitial page"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/docs/zrok/guides/self-hosting/error-pages",children:"Error Pages"})," - customizing error pages"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"getting-help",children:"Getting Help"}),"\n",(0,s.jsx)(n.p,{children:"If you encounter issues not covered in this guide:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Check the ",(0,s.jsx)(n.a,{href:"https://github.com/openziti/zrok/issues",children:"zrok GitHub Issues"})," for similar problems"]}),"\n",(0,s.jsxs)(n.li,{children:["Enable verbose logging: set the ",(0,s.jsx)(n.code,{children:"DL_USE_JSON=true"})," environment variable for structured logs"]}),"\n",(0,s.jsxs)(n.li,{children:["Join the ",(0,s.jsx)(n.a,{href:"https://openziti.discourse.group/",children:"OpenZiti Community"})," for support"]}),"\n",(0,s.jsx)(n.li,{children:"Review your configuration against the complete example in the Configuration Reference section"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},28453(e,n,i){i.d(n,{R:()=>a,x:()=>o});var r=i(96540);const s={},t=r.createContext(s);function a(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);